# üì° Antenna FFT Module - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

## ‚úÖ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### 1. CMake –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- `antenna-CMakeLists.txt` ‚Üí `modules/antenna/CMakeLists.txt`
  - –ù–∞–π—Ç–∏ clFFT –±–∏–±–ª–∏–æ—Ç–µ–∫—É
  - –°–æ–∑–¥–∞—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É antenna_module
  - –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å OpenCL kernels

### 2. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- `antenna_params.hpp` ‚Üí `modules/antenna/include/antenna_params.hpp`
  - `AntennaParams`: beam_count, count_points, out_count_points_fft, max_peaks_count
  - `BatchConfig`: memory_usage_limit, batch_size_ratio, min_beams_for_batch

- `antenna_result.hpp` ‚Üí `modules/antenna/include/antenna_result.hpp`
  - `FFTMaxValue`: index, amplitude, phase, real, imag
  - `BeamFFTResult`: max_values[], freq_offset, refined_frequency
  - `AntennaFFTResult`: results[], nFFT, task_id, module_name

### 3. –ì–ª–∞–≤–Ω—ã–π –º–æ–¥—É–ª—å
- `antenna_module.hpp` ‚Üí `modules/antenna/include/antenna_module.hpp`
  - –†–µ–∞–ª–∏–∑—É–µ—Ç `IComputeModule` –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
  - –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥: `ProcessNew()` —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –≤—ã–±–æ—Ä–æ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ ProcessNew()

```
ProcessNew(input_signal)
    ‚îÇ
    ‚îú‚îÄ EstimateRequiredMemory()
    ‚îÇ   ‚îî‚îÄ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å: input + FFT buffers + post buffers
    ‚îÇ
    ‚îú‚îÄ CheckAvailableMemory(required, 65%)
    ‚îÇ   ‚îî‚îÄ –°—Ä–∞–≤–Ω–∏—Ç—å —Å –¥–æ—Å—Ç—É–ø–Ω–æ–π –ø–∞–º—è—Ç—å—é GPU
    ‚îÇ
    ‚îî‚îÄ –ï–°–õ–ò –ø–∞–º—è—Ç–∏ —Ö–≤–∞—Ç–∞–µ—Ç:
        ‚îî‚îÄ ProcessSingleBatch()
            ‚îú‚îÄ –°–æ–∑–¥–∞—Ç—å –±—É—Ñ–µ—Ä—ã (–∫—ç—à)
            ‚îú‚îÄ –°–æ–∑–¥–∞—Ç—å FFT –ø–ª–∞–Ω (–∫—ç—à)
            ‚îú‚îÄ Padding kernel
            ‚îú‚îÄ FFT transform
            ‚îú‚îÄ Post kernel (magnitude + select)
            ‚îî‚îÄ Reduction kernel (–ø–æ–∏—Å–∫ –º–∞–∫—Å–∏–º—É–º–æ–≤)
    
    ‚îî‚îÄ –ò–ù–ê–ß–ï (–ø–∞–º—è—Ç–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç):
        ‚îî‚îÄ ProcessMultiBatch()
            ‚îú‚îÄ CalculateBatchSize()
            ‚îú‚îÄ –°–æ–∑–¥–∞—Ç—å –±—É—Ñ–µ—Ä—ã –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –±–∞—Ç—á–∞ (–∫—ç—à)
            ‚îú‚îÄ –°–æ–∑–¥–∞—Ç—å FFT –ø–ª–∞–Ω –¥–ª—è –±–∞—Ç—á–∞ (–∫—ç—à)
            ‚îÇ
            ‚îî‚îÄ FOR –∫–∞–∂–¥—ã–π –±–∞—Ç—á:
                ‚îú‚îÄ ProcessBatch(start_beam, num_beams)
                ‚îÇ   ‚îú‚îÄ Padding kernel (—Å offset!)
                ‚îÇ   ‚îú‚îÄ FFT transform
                ‚îÇ   ‚îú‚îÄ Post kernel
                ‚îÇ   ‚îî‚îÄ Reduction kernel
                ‚îÇ
                ‚îî‚îÄ –°–æ–±—Ä–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
```

---

## üìã –ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞

### ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ:
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å DrvGPU (IComputeModule, IBackend)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ SVMBuffer (zero-copy CPU-GPU)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ GPUBuffer –∏–∑ DrvGPU
- –ü–æ–ª–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ memory_manager

### ‚ùå –£–±—Ä–∞–Ω–æ:
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SVM)
- –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (—Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º)
- OpenCLComputeEngine –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- Parallel streams (–æ—Å—Ç–∞–≤–ª–µ–Ω –ø—Ä–æ—Å—Ç–æ–π batch processing)

### üîÑ –ò–∑–º–µ–Ω–µ–Ω–æ:
- Padding kernel –ø–æ–ª—É—á–∞–µ—Ç beam_offset –¥–ª—è batch —Ä–µ–∂–∏–º–∞
- –ë—É—Ñ–µ—Ä—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ MemoryManager DrvGPU
- Command queues –ø–æ–ª—É—á–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ IBackend
- –ö–æ–Ω—Ç–µ–∫—Å—Ç/—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —á–µ—Ä–µ–∑ IBackend

---

## üîë –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### ProcessNew(input_signal)
**–¶–µ–ª—å:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–õ–æ–≥–∏–∫–∞:**
1. –û—Ü–µ–Ω–∏—Ç—å —Ç—Ä–µ–±—É–µ–º—É—é –ø–∞–º—è—Ç—å
2. –ï—Å–ª–∏ –ø–∞–º—è—Ç–∏ >= 65% –¥–æ—Å—Ç—É–ø–Ω–æ–π ‚Üí ProcessSingleBatch()
3. –ï—Å–ª–∏ –ø–∞–º—è—Ç–∏ < 65% –¥–æ—Å—Ç—É–ø–Ω–æ–π ‚Üí ProcessMultiBatch()

### ProcessSingleBatch(input_signal)
**–¶–µ–ª—å:** –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ –ª—É—á–∏ –∑–∞ –æ–¥–∏–Ω –ø—Ä–æ—Ö–æ–¥

**Pipeline:**
1. –°–æ–∑–¥–∞—Ç—å/–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±—É—Ñ–µ—Ä—ã (nFFT * beam_count)
2. –°–æ–∑–¥–∞—Ç—å/–ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å FFT –ø–ª–∞–Ω
3. Padding kernel: –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å + zero pad
4. FFT: clfftEnqueueTransform
5. Post kernel: magnitude + select –¥–∏–∞–ø–∞–∑–æ–Ω
6. Reduction: –Ω–∞–π—Ç–∏ —Ç–æ–ø-N –º–∞–∫—Å–∏–º—É–º–æ–≤
7. –í–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### ProcessMultiBatch(input_signal)
**–¶–µ–ª—å:** –†–∞–∑–±–∏—Ç—å –Ω–∞ –±–∞—Ç—á–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ

**–õ–æ–≥–∏–∫–∞:**
1. CalculateBatchSize() ‚Üí 22% –æ—Ç total_beams
2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –±–∞—Ç—á < 3 –ª—É—á–µ–π, –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏–π
3. –°–æ–∑–¥–∞—Ç—å –±—É—Ñ–µ—Ä—ã –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –±–∞—Ç—á–∞ (–∫—ç—à)
4. –°–æ–∑–¥–∞—Ç—å FFT –ø–ª–∞–Ω –¥–ª—è –±–∞—Ç—á–∞ (–∫—ç—à)
5. FOR –∫–∞–∂–¥—ã–π –±–∞—Ç—á:
   - ProcessBatch(start_beam, num_beams)
   - –ù–∞–∫–æ–ø–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
6. –í–µ—Ä–Ω—É—Ç—å –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### ProcessBatch(start_beam, num_beams)
**–¶–µ–ª—å:** –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ–¥–∏–Ω –±–∞—Ç—á –ª—É—á–µ–π

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å:** Padding kernel –ø–æ–ª—É—á–∞–µ—Ç beam_offset –¥–ª—è —á—Ç–µ–Ω–∏—è –∏–∑ –Ω—É–∂–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –≤—Ö–æ–¥–Ω–æ–≥–æ –±—É—Ñ–µ—Ä–∞!

**Pipeline:**
1. Padding kernel(input_signal, offset=start_beam)
2. FFT transform
3. Post kernel
4. Reduction kernel
5. –í–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–∞—Ç—á–∞

---

## üì¶ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë—É—Ñ–µ—Ä—ã (–∫—ç—à):
- `buffer_fft_input_` - –¥–ª—è –ø–æ–ª–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `buffer_fft_output_` - –¥–ª—è –ø–æ–ª–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `batch_fft_input_` - –¥–ª—è batch –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `batch_fft_output_` - –¥–ª—è batch –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `buffer_maxima_` - –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ reduction

**–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –ï—Å–ª–∏ —Ä–∞–∑–º–µ—Ä –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è, –±—É—Ñ–µ—Ä—ã –Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—é—Ç—Å—è!

### FFT –ø–ª–∞–Ω—ã (–∫—ç—à):
- `main_plan_handle_` - –ø–ª–∞–Ω –¥–ª—è –ø–æ–ª–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `batch_plan_handle_` - –ø–ª–∞–Ω –¥–ª—è batch –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `batch_plan_beams_` - —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–ª–∞–Ω–∞

**–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –ü–ª–∞–Ω –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è —Ä–∞–∑–º–µ—Ä!

---

## üî¢ –í—ã—á–∏—Å–ª–µ–Ω–∏–µ nFFT

```cpp
CalculateNFFT(count_points):
    1. –ï—Å–ª–∏ –Ω–µ —Å—Ç–µ–ø–µ–Ω—å 2 ‚Üí NextPowerOf2(count_points)
    2. –£–º–Ω–æ–∂–∏—Ç—å –Ω–∞ 2
    3. –í–µ—Ä–Ω—É—Ç—å nFFT
```

**–ü—Ä–∏–º–µ—Ä:**
- count_points = 1000 ‚Üí NextPowerOf2 = 1024 ‚Üí nFFT = 2048
- count_points = 512 ‚Üí —Å—Ç–µ–ø–µ–Ω—å 2 ‚Üí nFFT = 1024

---

## üéØ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥

–°–æ–∑–¥–∞—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é (.cpp —Ñ–∞–π–ª) —Å:
1. –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä/–¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä
2. Initialize() / Cleanup()
3. ProcessNew() - –≥–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
4. ProcessSingleBatch()
5. ProcessMultiBatch()
6. ProcessBatch()
7. –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã

---

## üìù OpenCL Kernels (–±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ)

1. **padding_kernel** - –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å zero padding
2. **post_kernel** - magnitude + –≤—ã–±–æ—Ä –¥–∏–∞–ø–∞–∑–æ–Ω–∞
3. **reduction_kernel** - –ø–æ–∏—Å–∫ —Ç–æ–ø-N –º–∞–∫—Å–∏–º—É–º–æ–≤

---

**–ì–æ—Ç–æ–≤–æ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏!** üöÄ
