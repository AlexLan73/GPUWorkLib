/**
 * @file example_external_context_usage.cpp
 * @brief ĞŸĞĞ›ĞĞ«Ğ™ ĞŸĞ Ğ˜ĞœĞ•Ğ  Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ DrvGPU Ñ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğ¼ OpenCL ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼
 *
 * Ğ¡Ğ¦Ğ•ĞĞĞ Ğ˜Ğ™:
 * Ğ£ Ğ²Ğ°Ñ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ OpenCL ĞºĞ¾Ğ´ (ĞºĞ»Ğ°ÑÑ YourExistingOpenCL).
 * Ğ’Ñ‹ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ DrvGPU Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ¸Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ°Ğ¼ÑÑ‚ÑŒÑ.
 *
 * @author DrvGPU Team
 * @date 2026-02-01
 */

#include "DrvGPU/backends/opencl/opencl_backend_external.hpp"
#include "DrvGPU/drv_gpu.hpp"
#include <CL/cl.h>
#include <vector>
#include <iostream>

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ¡Ğ˜ĞœĞ£Ğ›Ğ¯Ğ¦Ğ˜Ğ¯ Ğ²Ğ°ÑˆĞµĞ³Ğ¾ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ³Ğ¾ OpenCL ĞºĞ»Ğ°ÑÑĞ°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class YourExistingOpenCL
{
public:
  YourExistingOpenCL()
  {
    // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ OpenCL (Ğ²Ğ°Ñˆ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ ĞºĞ¾Ğ´)
    InitializeOpenCL();

    // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ±ÑƒÑ„ĞµÑ€Ğ¾Ğ² (Ğ²Ğ°Ñˆ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ ĞºĞ¾Ğ´)
    CreateBuffers();
  }

  ~YourExistingOpenCL()
  {
    // ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° (Ğ²Ğ°Ñˆ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ ĞºĞ¾Ğ´)
    CleanupBuffers();
    CleanupOpenCL();
  }

  // Ğ“ĞµÑ‚Ñ‚ĞµÑ€Ñ‹ Ğ´Ğ»Ñ OpenCL Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ²
  cl_context GetContext() const { return context_; }
  cl_device_id GetDevice() const { return device_; }
  cl_command_queue GetQueue() const { return queue_; }
  cl_mem GetDataBuffer() const { return data_buffer_; }

private:
  cl_platform_id platform_;
  cl_device_id device_;
  cl_context context_;
  cl_command_queue queue_;

  cl_mem data_buffer_; // Ğ’Ğ°Ñˆ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ Ğ±ÑƒÑ„ĞµÑ€ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

  void InitializeOpenCL()
  {
    // Ğ’Ğ°Ñˆ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ ĞºĞ¾Ğ´ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ OpenCL
    cl_int err;

    // 1. Platform
    err = clGetPlatformIDs(1, &platform_, nullptr);
    if (err != CL_SUCCESS)
      throw std::runtime_error("Platform init failed");

    // 2. Device
    err = clGetDeviceIDs(platform_, CL_DEVICE_TYPE_GPU, 1, &device_, nullptr);
    if (err != CL_SUCCESS)
      throw std::runtime_error("Device init failed");

    // 3. Context
    context_ = clCreateContext(nullptr, 1, &device_, nullptr, nullptr, &err);
    if (err != CL_SUCCESS)
      throw std::runtime_error("Context creation failed");

    // 4. Queue
    queue_ = clCreateCommandQueue(context_, device_, 0, &err);
    if (err != CL_SUCCESS)
      throw std::runtime_error("Queue creation failed");

    std::cout << "âœ… YourExistingOpenCL: Initialized\n";
  }

  void CreateBuffers()
  {
    cl_int err;

    // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ±ÑƒÑ„ĞµÑ€ Ğ½Ğ° 1024 float ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ°
    size_t buffer_size = 1024 * sizeof(float);
    data_buffer_ = clCreateBuffer(
        context_,
        CL_MEM_READ_WRITE,
        buffer_size,
        nullptr,
        &err);

    if (err != CL_SUCCESS)
      throw std::runtime_error("Buffer creation failed");

    // Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ±ÑƒÑ„ĞµÑ€ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸
    std::vector<float> test_data(1024);
    for (size_t i = 0; i < test_data.size(); ++i)
    {
      test_data[i] = static_cast<float>(i);
    }

    err = clEnqueueWriteBuffer(
        queue_,
        data_buffer_,
        CL_TRUE,
        0,
        buffer_size,
        test_data.data(),
        0,
        nullptr,
        nullptr);

    if (err != CL_SUCCESS)
      throw std::runtime_error("Buffer write failed");

    std::cout << "âœ… YourExistingOpenCL: Created and filled data_buffer\n";
  }

  void CleanupBuffers()
  {
    if (data_buffer_)
      clReleaseMemObject(data_buffer_);
  }

  void CleanupOpenCL()
  {
    if (queue_)
      clReleaseCommandQueue(queue_);
    if (context_)
      clReleaseContext(context_);
    if (device_)
      clReleaseDevice(device_);
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞŸĞ Ğ˜ĞœĞ•Ğ  1: Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ²Ğ½ĞµÑˆĞ½ĞµĞ³Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

void Example1_BasicExternalContext()
{
  std::cout << "\n"
            << std::string(80, 'â•') << "\n";
  std::cout << "EXAMPLE 1: Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ²Ğ½ĞµÑˆĞ½ĞµĞ³Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°\n";
  std::cout << std::string(80, 'â•') << "\n\n";

  // Ğ¨ĞĞ“ 1: Ğ£ Ğ²Ğ°Ñ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ OpenCL ĞºĞ¾Ğ´
  YourExistingOpenCL your_opencl;

  // Ğ¨ĞĞ“ 2: Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ DrvGPU backend Ñ Ğ’ĞĞ¨Ğ˜Ğœ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼
  drv_gpu_lib::OpenCLBackendExternal backend(
      your_opencl.GetContext(), // Ğ’Ğ°Ñˆ context
      your_opencl.GetDevice(),  // Ğ’Ğ°Ñˆ device
      your_opencl.GetQueue(),   // Ğ’Ğ°Ñˆ queue
      false                     // ĞĞ• Ğ²Ğ»Ğ°Ğ´ĞµĞµÑ‚ Ñ€ĞµÑÑƒÑ€ÑĞ°Ğ¼Ğ¸
  );

  // Ğ¨ĞĞ“ 3: Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ DrvGPU Ñ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼
  backend.InitializeWithExternalContext();

  // Ğ¨ĞĞ“ 4: Ğ¢ĞµĞ¿ĞµÑ€ÑŒ DrvGPU Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ñ Ğ²Ğ°ÑˆĞ¸Ğ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼!
  std::cout << "\nâœ… DrvGPU ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ñ Ğ²Ğ°ÑˆĞ¸Ğ¼ OpenCL!\n";
  std::cout << "   Device: " << backend.GetDeviceName() << "\n";

  // Backend Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¾Ñ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑÑ Ğ² Ğ´ĞµÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€Ğµ
  // Ğ’Ğ°Ñˆ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚/device/queue ĞĞ• Ğ±ÑƒĞ´ÑƒÑ‚ ÑƒĞ½Ğ¸Ñ‡Ñ‚Ğ¾Ğ¶ĞµĞ½Ñ‹!
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞŸĞ Ğ˜ĞœĞ•Ğ  2: Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ñ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğ¼Ğ¸ cl_mem Ğ±ÑƒÑ„ĞµÑ€Ğ°Ğ¼Ğ¸ (ĞšĞ›Ğ®Ğ§Ğ•Ğ’ĞĞ™ USE CASE)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

void Example2_ExternalBufferAdapter()
{
  std::cout << "\n"
            << std::string(80, 'â•') << "\n";
  std::cout << "EXAMPLE 2: Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ñ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğ¼Ğ¸ cl_mem Ğ±ÑƒÑ„ĞµÑ€Ğ°Ğ¼Ğ¸\n";
  std::cout << std::string(80, 'â•') << "\n\n";

  // Ğ¨ĞĞ“ 1: Ğ’Ğ°Ñˆ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ OpenCL ĞºĞ¾Ğ´
  YourExistingOpenCL your_opencl;

  // Ğ¨ĞĞ“ 2: DrvGPU backend Ñ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼
  drv_gpu_lib::OpenCLBackendExternal backend(
      your_opencl.GetContext(),
      your_opencl.GetDevice(),
      your_opencl.GetQueue());
  backend.InitializeWithExternalContext();

  // Ğ¨ĞĞ“ 3: Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ°Ğ´Ğ°Ğ¿Ñ‚ĞµÑ€ Ğ´Ğ»Ñ Ğ’ĞĞ¨Ğ•Ğ“Ğ cl_mem Ğ±ÑƒÑ„ĞµÑ€Ğ°
  cl_mem your_buffer = your_opencl.GetDataBuffer();

  auto adapter = backend.CreateExternalBufferAdapter<float>(
      your_buffer, // Ğ’Ğ°Ñˆ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ Ğ±ÑƒÑ„ĞµÑ€
      1024,        // ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ float ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
      false        // ĞĞ• Ğ²Ğ»Ğ°Ğ´ĞµĞµÑ‚ Ğ±ÑƒÑ„ĞµÑ€Ğ¾Ğ¼
  );

  std::cout << "\nâœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ğ°Ğ´Ğ°Ğ¿Ñ‚ĞµÑ€ Ğ´Ğ»Ñ Ğ²Ğ½ĞµÑˆĞ½ĞµĞ³Ğ¾ cl_mem Ğ±ÑƒÑ„ĞµÑ€Ğ°\n";

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // USE CASE 1: Ğ—ĞĞ“Ğ Ğ£Ğ—Ğ˜Ğ¢Ğ¬ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ GPU -> Host
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  std::cout << "\nğŸ“¥ Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ GPU...\n";
  std::vector<float> data_from_gpu = adapter->Read();

  std::cout << "   ĞŸÑ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²: " << data_from_gpu.size() << "\n";
  std::cout << "   ĞŸĞµÑ€Ğ²Ñ‹Ğµ 5 ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²: ";
  for (size_t i = 0; i < 5; ++i)
  {
    std::cout << data_from_gpu[i] << " ";
  }
  std::cout << "\n";

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // USE CASE 2: ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğ° CPU
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  std::cout << "\nğŸ”„ ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğ° CPU (ÑƒĞ¼Ğ½Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ½Ğ° 2)...\n";
  for (auto &val : data_from_gpu)
  {
    val *= 2.0f;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // USE CASE 3: Ğ’Ğ«Ğ“Ğ Ğ£Ğ—Ğ˜Ğ¢Ğ¬ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Host -> GPU
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  std::cout << "\nğŸ“¤ Ğ’Ğ«Ğ“Ğ Ğ£Ğ—ĞšĞ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğ° GPU...\n";
  adapter->Write(data_from_gpu);

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // USE CASE 4: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  std::cout << "\nğŸ” ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ° (Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑĞ½Ğ¾Ğ²Ğ°)...\n";
  std::vector<float> result = adapter->Read();

  std::cout << "   ĞŸĞµÑ€Ğ²Ñ‹Ğµ 5 ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸: ";
  for (size_t i = 0; i < 5; ++i)
  {
    std::cout << result[i] << " ";
  }
  std::cout << "\n";

  std::cout << "\nâœ… Ğ¦Ğ¸ĞºĞ» Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ -> ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ -> Ğ’Ğ«Ğ“Ğ Ğ£Ğ—ĞšĞ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½!\n";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞŸĞ Ğ˜ĞœĞ•Ğ  3: Ğ£Ñ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ¿Ñ€ÑĞ¼Ğ¾Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ±ÑƒÑ„ĞµÑ€Ğ°Ğ¼Ğ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

void Example3_DirectBufferUtilities()
{
  std::cout << "\n"
            << std::string(80, 'â•') << "\n";
  std::cout << "EXAMPLE 3: ĞŸÑ€ÑĞ¼Ñ‹Ğµ ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ±ÑƒÑ„ĞµÑ€Ğ°Ğ¼Ğ¸\n";
  std::cout << std::string(80, 'â•') << "\n\n";

  YourExistingOpenCL your_opencl;

  drv_gpu_lib::OpenCLBackendExternal backend(
      your_opencl.GetContext(),
      your_opencl.GetDevice(),
      your_opencl.GetQueue());
  backend.InitializeWithExternalContext();

  cl_mem your_buffer = your_opencl.GetDataBuffer();

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ĞœĞµÑ‚Ğ¾Ğ´ 1: ĞŸÑ€ÑĞ¼Ğ°Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ñ‡ĞµÑ€ĞµĞ· ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚Ñƒ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  std::cout << "\nğŸ“¤ ĞŸÑ€ÑĞ¼Ğ°Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ñ‡ĞµÑ€ĞµĞ· WriteToExternalBuffer()...\n";
  std::vector<float> new_data(1024, 99.0f);

  backend.WriteToExternalBuffer(
      your_buffer,
      new_data.data(),
      new_data.size() * sizeof(float),
      true // blocking
  );

  std::cout << "   Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ğ½Ğ¾ " << new_data.size() << " ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²\n";

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ĞœĞµÑ‚Ğ¾Ğ´ 2: ĞŸÑ€ÑĞ¼Ğ¾Ğµ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚Ñƒ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  std::cout << "\nğŸ“¥ ĞŸÑ€ÑĞ¼Ğ¾Ğµ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· ReadFromExternalBuffer()...\n";
  std::vector<float> read_data(1024);

  backend.ReadFromExternalBuffer(
      your_buffer,
      read_data.data(),
      read_data.size() * sizeof(float),
      true // blocking
  );

  std::cout << "   ĞŸÑ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ¾ " << read_data.size() << " ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²\n";
  std::cout << "   Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ°: " << read_data[0] << "\n";

  std::cout << "\nâœ… ĞŸÑ€ÑĞ¼Ñ‹Ğµ ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚!\n";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞŸĞ Ğ˜ĞœĞ•Ğ  4: ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

void Example4_AsyncOperations()
{
  std::cout << "\n"
            << std::string(80, 'â•') << "\n";
  std::cout << "EXAMPLE 4: ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸\n";
  std::cout << std::string(80, 'â•') << "\n\n";

  YourExistingOpenCL your_opencl;

  drv_gpu_lib::OpenCLBackendExternal backend(
      your_opencl.GetContext(),
      your_opencl.GetDevice(),
      your_opencl.GetQueue());
  backend.InitializeWithExternalContext();

  auto adapter = backend.CreateExternalBufferAdapter<float>(
      your_opencl.GetDataBuffer(),
      1024);

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  std::cout << "\nğŸ“¤ ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ...\n";
  std::vector<float> async_data(1024, 42.0f);

  cl_event write_event = adapter->WriteAsync(async_data);

  std::cout << "   Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ° Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾\n";
  std::cout << "   ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ´Ñ€ÑƒĞ³ÑƒÑ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ...\n";

  // Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ
  clWaitForEvents(1, &write_event);
  clReleaseEvent(write_event);

  std::cout << "   Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ° âœ…\n";

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğµ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  std::cout << "\nğŸ“¥ ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğµ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ...\n";
  std::vector<float> async_result;

  cl_event read_event = adapter->ReadAsync(async_result);

  std::cout << "   Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾\n";
  std::cout << "   ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ´Ñ€ÑƒĞ³ÑƒÑ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ...\n";

  // Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ
  clWaitForEvents(1, &read_event);
  clReleaseEvent(read_event);

  std::cout << "   Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾ âœ…\n";
  std::cout << "   Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ³Ğ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ°: " << async_result[0] << "\n";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN: Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ²ÑĞµÑ… Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ¾Ğ²
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
namespace external_context_example
{
  int run()
  {
    std::cout << R"(
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                            â•‘
â•‘   DrvGPU - ĞŸĞ Ğ˜ĞœĞ•Ğ Ğ« Ğ ĞĞ‘ĞĞ¢Ğ« Ğ¡ Ğ’ĞĞ•Ğ¨ĞĞ˜Ğœ OpenCL ĞšĞĞĞ¢Ğ•ĞšĞ¡Ğ¢ĞĞœ                     â•‘
â•‘                                                                            â•‘
â•‘   ĞĞ²Ñ‚Ğ¾Ñ€: DrvGPU Team                                                       â•‘
â•‘   Ğ”Ğ°Ñ‚Ğ°: 2026-02-01                                                         â•‘
â•‘   ĞšÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸Ğ¹: ĞĞ°Ğ´ĞµĞ¶Ğ½Ğ¾ÑÑ‚ÑŒ + ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ñ‚Ğ°                                         â•‘
â•‘                                                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    )";

    try
    {
      // ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ 1: Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ
      Example1_BasicExternalContext();

      // ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ 2: Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ñ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğ¼Ğ¸ Ğ±ÑƒÑ„ĞµÑ€Ğ°Ğ¼Ğ¸ (ĞšĞ›Ğ®Ğ§Ğ•Ğ’ĞĞ™)
      Example2_ExternalBufferAdapter();

      // ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ 3: ĞŸÑ€ÑĞ¼Ñ‹Ğµ ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹
      Example3_DirectBufferUtilities();

      // ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ 4: ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
      Example4_AsyncOperations();

      std::cout << "\n"
                << std::string(80, 'â•') << "\n";
      std::cout << "âœ… Ğ’Ğ¡Ğ• ĞŸĞ Ğ˜ĞœĞ•Ğ Ğ« Ğ’Ğ«ĞŸĞĞ›ĞĞ•ĞĞ« Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ!\n";
      std::cout << std::string(80, 'â•') << "\n\n";

      return 0;
    }
    catch (const std::exception &e)
    {
      std::cerr << "\nâŒ ĞĞ¨Ğ˜Ğ‘ĞšĞ: " << e.what() << "\n";
      return 1;
    }
  }
}