/**
 * @file test_vector_ops.cpp
 * @brief –¢–µ—Å—Ç VectorOpsModule - –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö 6 –æ–ø–µ—Ä–∞—Ü–∏–π
 * 
 * –°—Ü–µ–Ω–∞—Ä–∏–π: –°–æ–∑–¥–∞—Ç—å –≤–µ–∫—Ç–æ—Ä [0..1023], –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
 * 
 * @author DrvGPU Team
 * @date 2026-02-03
 */

#include "drv_gpu.hpp"
#include "vector_ops_module.hpp"
#include <iostream>
#include <iomanip>
#include <vector>

namespace test_example_mat{
using namespace drv_gpu_lib;

void PrintVector(const std::string& name, const std::vector<float>& vec, size_t count = 5) {
    std::cout << name << ": [";
    for (size_t i = 0; i < std::min(count, vec.size()); ++i) {
        std::cout << std::fixed << std::setprecision(1) << vec[i];
        if (i < std::min(count, vec.size()) - 1) std::cout << ", ";
    }
    std::cout << ", ...]" << std::endl;
}

std::vector<float> CreateSequence(size_t n) {
    std::vector<float> vec(n);
    for (size_t i = 0; i < n; ++i) {
        vec[i] = static_cast<float>(i);
    }
    return vec;
}

int run() {
    std::cout << "\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
    std::cout << "  VectorOpsModule Test - –ü—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –≤–µ–∫—Ç–æ—Ä–∞–º–∏\n";
    std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";
    
    try {
        std::cout << "üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è DrvGPU (OpenCL, device 0)...\n";
        DrvGPU gpu(BackendType::OPENCL, 0);
        gpu.Initialize();
        std::cout << "‚úÖ DrvGPU initialized\n";
        std::cout << "   Device: " << gpu.GetDeviceName() << "\n\n";
        
        std::cout << "üîß –°–æ–∑–¥–∞–Ω–∏–µ VectorOpsModule...\n";
        auto module = std::make_shared<VectorOpsModule>(&gpu.GetBackend());
        module->Initialize();
        gpu.GetModuleRegistry().RegisterModule("VectorOps", module);
        std::cout << "‚úÖ VectorOpsModule –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω\n\n";
        
        const size_t N = 1024;
        std::cout << "üìä –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ö–æ–¥–Ω–æ–≥–æ –≤–µ–∫—Ç–æ—Ä–∞ [0, 1, 2, ..., " << (N-1) << "]\n";
        
        auto host_A = CreateSequence(N);
        PrintVector("A (host)", host_A, 5);
        std::cout << "\n";
        
        auto& mem_mgr = gpu.GetMemoryManager();
        auto gpu_A = mem_mgr.CreateBuffer<float>(host_A.data(), N);
        auto gpu_C1 = mem_mgr.CreateBuffer<float>(N);
        auto gpu_C2 = mem_mgr.CreateBuffer<float>(N);
        auto gpu_C3 = mem_mgr.CreateBuffer<float>(N);
        
        std::cout << "‚úÖ GPU –±—É—Ñ–µ—Ä—ã –≤—ã–¥–µ–ª–µ–Ω—ã (4 –±—É—Ñ–µ—Ä–∞ –ø–æ " << N << " —ç–ª–µ–º–µ–Ω—Ç–æ–≤)\n\n";
        
        std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        std::cout << "  –¢–ï–°–¢ 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∫–∞–ª—è—Ä–∞ (out-of-place)\n";
        std::cout << "  –û–ø–µ—Ä–∞—Ü–∏—è: C1[] = A[] + 1\n";
        std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        module->AddOneOut(gpu_A, gpu_C1, N);
        auto result_C1 = gpu_C1->Read();
        PrintVector("C1 = A + 1", result_C1, 5);
        std::cout << "‚úÖ –¢–µ—Å—Ç 1 –∑–∞–≤–µ—Ä—à—ë–Ω\n\n";
        
        std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        std::cout << "  –¢–ï–°–¢ 2: –í—ã—á–∏—Ç–∞–Ω–∏–µ —Å–∫–∞–ª—è—Ä–∞ (out-of-place)\n";
        std::cout << "  –û–ø–µ—Ä–∞—Ü–∏—è: C2[] = A[] - 1\n";
        std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        module->SubOneOut(gpu_A, gpu_C2, N);
        auto result_C2 = gpu_C2->Read();
        PrintVector("C2 = A - 1", result_C2, 5);
        std::cout << "‚úÖ –¢–µ—Å—Ç 2 –∑–∞–≤–µ—Ä—à—ë–Ω\n\n";
        
        std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        std::cout << "  –¢–ï–°–¢ 3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∫–∞–ª—è—Ä–∞ (in-place)\n";
        std::cout << "  –û–ø–µ—Ä–∞—Ü–∏—è: A[] = A[] + 1\n";
        std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        module->AddOneInPlace(gpu_A, N);
        auto result_A_after_add = gpu_A->Read();
        PrintVector("A (–ø–æ—Å–ª–µ +1)", result_A_after_add, 5);
        std::cout << "‚úÖ –¢–µ—Å—Ç 3 –∑–∞–≤–µ—Ä—à—ë–Ω\n\n";
        
        std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        std::cout << "  –¢–ï–°–¢ 4: –í—ã—á–∏—Ç–∞–Ω–∏–µ —Å–∫–∞–ª—è—Ä–∞ (in-place)\n";
        std::cout << "  –û–ø–µ—Ä–∞—Ü–∏—è: A[] = A[] - 1 (–≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É)\n";
        std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        module->SubOneInPlace(gpu_A, N);
        auto result_A_after_sub = gpu_A->Read();
        PrintVector("A (–ø–æ—Å–ª–µ -1)", result_A_after_sub, 5);
        std::cout << "‚úÖ –¢–µ—Å—Ç 4 –∑–∞–≤–µ—Ä—à—ë–Ω (A –≤–µ—Ä–Ω—É–ª–æ—Å—å –∫ [0, 1, 2, ...])\n\n";
        
        std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        std::cout << "  –¢–ï–°–¢ 5: –°–ª–æ–∂–µ–Ω–∏–µ –¥–≤—É—Ö –≤–µ–∫—Ç–æ—Ä–æ–≤ (out-of-place)\n";
        std::cout << "  –û–ø–µ—Ä–∞—Ü–∏—è: C3[] = C1[] + C2[]\n";
        std::cout << "  –û–∂–∏–¥–∞–µ—Ç—Å—è: C3[i] = (A[i] + 1) + (A[i] - 1) = 2 * A[i]\n";
        std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        module->AddVectorsOut(gpu_C1, gpu_C2, gpu_C3, N);
        auto result_C3 = gpu_C3->Read();
        PrintVector("C3 = C1 + C2", result_C3, 5);
        std::cout << "‚úÖ –¢–µ—Å—Ç 5 –∑–∞–≤–µ—Ä—à—ë–Ω\n\n";
        
        std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        std::cout << "  –¢–ï–°–¢ 6: –°–ª–æ–∂–µ–Ω–∏–µ –¥–≤—É—Ö –≤–µ–∫—Ç–æ—Ä–æ–≤ (in-place)\n";
        std::cout << "  –û–ø–µ—Ä–∞—Ü–∏—è: C3[] = C3[] + C2[]\n";
        std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        module->AddVectorsInPlace(gpu_C3, gpu_A, N);
        auto result_C1_final = gpu_C3->Read();
        PrintVector("C3 (–ø–æ—Å–ª–µ += C2)", result_C1_final, 5);
        std::cout << "‚úÖ –¢–µ—Å—Ç 6 –∑–∞–≤–µ—Ä—à—ë–Ω\n\n";
        
        std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n";
        std::cout << "‚úÖ –í—Å–µ 6 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!\n\n";
        
        mem_mgr.PrintStatistics();
        
        std::cout << "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n";
        
        return 0;
        
    } catch (const std::exception& e) {
        std::cerr << "\n‚ùå –û–®–ò–ë–ö–ê: " << e.what() << "\n\n";
        return 1;
    }
}
}