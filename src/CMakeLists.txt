# ============================================================================
# Main CMakeLists for src/
# src/CMakeLists.txt
# ============================================================================
# –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï: –ì–ª–∞–≤–Ω–∞—è —Å–±–æ—Ä–∫–∞ (header-only –º–æ–¥—É–ª–∏)
# ============================================================================

message(STATUS "")
message(STATUS "üîß Processing: src/ (Main build)")
message(STATUS "")

# ============================================================================
# –ü–û–î–ú–û–î–£–õ–ò (header-only)
# ============================================================================

# OpenCL Manager Library
#add_subdirectory(ManagerOpenCL)

# GPU Module (header-only)
#add_subdirectory(GPU)

# Tests Module (header-only)
#add_subdirectory(Test)

# ============================================================================
# –ò–°–•–û–î–ù–´–ï –§–ê–ô–õ–´ –ì–õ–ê–í–ù–û–ì–û –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
# ============================================================================

set(MAIN_SOURCES
    main.cpp
)

# ============================================================================
# –°–û–ó–î–ê–ù–ò–ï –ò–°–ü–û–õ–ù–Ø–ï–ú–û–ì–û –§–ê–ô–õ–ê
# ============================================================================

add_executable(GPUWorkLib ${MAIN_SOURCES})

message(STATUS "üî® Creating main executable: GPUWorkLib")

# ============================================================================
# –õ–ò–ù–ö–û–í–ö–ê –° DrvGPU –ë–ò–ë–õ–ò–û–¢–ï–ö–û–ô
# ============================================================================

# –õ–∏–Ω–∫—É–µ–º —Å DrvGPU –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π (–µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∫–∞–∫ —Ü–µ–ª—å)
if(TARGET DrvGPU::drvgpu)
    target_link_libraries(GPUWorkLib PRIVATE DrvGPU::drvgpu)
    message(STATUS "‚úÖ Linked: DrvGPU::drvgpu")
endif()

# ============================================================================
# OpenCL - –ü–†–ê–í–ò–õ–¨–ù–´–ô –°–ü–û–°–û–ë —á–µ—Ä–µ–∑ imported target
# ============================================================================
if(OPENCL_ENABLED)
    if(TARGET OpenCL::OpenCL)
        target_link_libraries(GPUWorkLib PRIVATE OpenCL::OpenCL)
        message(STATUS "‚úÖ Linked: OpenCL::OpenCL (imported target)")
    elseif(OpenCL_LIBRARY)
        # Windows: –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–π–¥–µ–Ω–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É
        target_link_libraries(GPUWorkLib PRIVATE "${OpenCL_LIBRARY}")
        message(STATUS "‚úÖ Linked: ${OpenCL_LIBRARY}")
    elseif(OpenCL_LIBRARIES)
        # Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π CMake
        target_link_libraries(GPUWorkLib PRIVATE ${OpenCL_LIBRARIES})
        message(STATUS "‚úÖ Linked: ${OpenCL_LIBRARIES}")
    else()
        message(WARNING "‚ö†Ô∏è  OpenCL library not found, skipping link")
    endif()
endif()

# clFFT (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ - –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ –Ω–µ–≥–æ)
if(CLFFT_FOUND AND CLFFT_LIB)
    target_link_libraries(GPUWorkLib PRIVATE "${CLFFT_LIB}")
    message(STATUS "‚úÖ Linked: clFFT")
else()
    message(STATUS "‚è≠Ô∏è  clFFT not found - FFT support disabled")
endif()

# CUDA (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
if(CUDA_FOUND)
    target_link_libraries(GPUWorkLib PRIVATE ${CUDA_LIBRARIES})
    target_include_directories(GPUWorkLib PRIVATE ${CUDA_INCLUDE_DIRS})
    target_compile_definitions(GPUWorkLib PRIVATE CUDA_ENABLED=1)
    message(STATUS "‚úÖ Linked: CUDA")
endif()

# nlohmann_json
if(NLOHMANN_JSON_FOUND AND TARGET nlohmann_json::nlohmann_json)
    target_link_libraries(GPUWorkLib PRIVATE nlohmann_json::nlohmann_json)
    message(STATUS "‚úÖ Linked: nlohmann_json")
endif()

# ============================================================================
# –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï INCLUDE –î–ò–†–ï–ö–¢–û–†–ò–ô
# ============================================================================

target_include_directories(GPUWorkLib PRIVATE
    ${CMAKE_SOURCE_DIR}/include
    ${CMAKE_SOURCE_DIR}/include/interface
    ${CMAKE_SOURCE_DIR}/src
    ${CMAKE_SOURCE_DIR}/tests
)
#    ${CMAKE_SOURCE_DIR}/include/ManagerOpenCL
#    ${CMAKE_SOURCE_DIR}/include/GPU
#    ${CMAKE_SOURCE_DIR}/include/Test

# OpenCL includes
if(OPENCL_ENABLED)
    target_include_directories(GPUWorkLib PRIVATE ${OpenCL_INCLUDE_DIRS})
endif()

# clFFT includes
if(CLFFT_FOUND)
    target_include_directories(GPUWorkLib PRIVATE ${CLFFT_INCLUDE_DIR})
endif()

# ============================================================================
# COMPILER FLAGS
# ============================================================================

if(MSVC)
    target_compile_options(GPUWorkLib PRIVATE /W4 /arch:AVX2 /Gy)
else()
    target_compile_options(GPUWorkLib PRIVATE -Wall -Wextra -march=native)
endif()

# ============================================================================
# COMPILE DEFINITIONS
# ============================================================================

if(OPENCL_ENABLED)
    target_compile_definitions(GPUWorkLib PRIVATE
        OPENCL_ENABLED=1
        CL_TARGET_OPENCL_VERSION=300
    )
endif()

if(CLFFT_FOUND)
    target_compile_definitions(GPUWorkLib PRIVATE
        CLFFT_VERSION=2
    )
endif()

# ============================================================================
# SET PROPERTIES
# ============================================================================

set_target_properties(GPUWorkLib PROPERTIES
    VERSION 1.0.0
    CXX_STANDARD 17
    CXX_STANDARD_REQUIRED ON
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}"
)

# ============================================================================
# POST-BUILD: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ DLL –Ω–∞ Windows (–µ—Å–ª–∏ –µ—Å—Ç—å)
# ============================================================================

if(IS_WINDOWS AND CLFFT_FOUND)
    # –ï—Å–ª–∏ DLL —É–∂–µ –Ω–∞–π–¥–µ–Ω –≤ dependencies.cmake
    if(CLFFT_DLL)
        add_custom_command(TARGET GPUWorkLib POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E copy_if_different
                "${CLFFT_DLL}"
                "$<TARGET_FILE_DIR:GPUWorkLib>"
            COMMENT "Copying clFFT.dll to executable directory"
        )
        message(STATUS "‚úÖ Will copy clFFT.dll to output directory")
    else()
        # Fallback: –∏—â–µ–º clFFT.dll —Ä—è–¥–æ–º —Å lib –∏–ª–∏ –≤ clFFT/bin
        set(CLFFT_DLL_PATHS
            "${CMAKE_SOURCE_DIR}/clFFT/lib"
            "${CMAKE_SOURCE_DIR}/clFFT/bin"
            "${CMAKE_SOURCE_DIR}/clFFT"
        )
        find_file(CLFFT_DLL NAMES clFFT.dll PATHS ${CLFFT_DLL_PATHS} NO_DEFAULT_PATH)
        if(CLFFT_DLL)
            add_custom_command(TARGET GPUWorkLib POST_BUILD
                COMMAND ${CMAKE_COMMAND} -E copy_if_different
                    "${CLFFT_DLL}"
                    "$<TARGET_FILE_DIR:GPUWorkLib>"
                COMMENT "Copying clFFT.dll to executable directory"
            )
            message(STATUS "‚úÖ Will copy clFFT.dll: ${CLFFT_DLL}")
        else()
            message(WARNING "‚ö†Ô∏è  clFFT.dll not found for copying")
        endif()
    endif()
endif()

message(STATUS "‚úÖ Main executable configured: GPUWorkLib")
message(STATUS "   Output: ${CMAKE_BINARY_DIR}/GPUWorkLib")
message(STATUS "")
